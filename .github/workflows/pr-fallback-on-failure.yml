name: pr-fallback-on-failure

on:
  workflow_run:
    workflows: ["ops-v0.3"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write

jobs:
  mark_pr_for_manual_review:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Add fallback label/comment on linked PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = context.payload.workflow_run.id;

            const prs = context.payload.workflow_run.pull_requests || [];
            for (const pr of prs) {
              await github.rest.issues.addLabels({
                owner, repo, issue_number: pr.number, labels: ['fallback-manual-review']
              });
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr.number,
                body: `Checks fehlgeschlagen (Run #${runId}). Auto-Merge bleibt aus. Bitte Fallback-Runbook aus docs/auto-merge-flow.md ausf√ºhren.`
              });
            }
