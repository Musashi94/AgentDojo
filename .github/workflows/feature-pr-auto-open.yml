name: Auto-open PR from feat/*

on:
  push:
    branches:
      - 'feat/**'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: auto-pr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Create or update PR
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = context.ref.replace('refs/heads/', '');
            const base = 'main';

            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${head}`,
              base
            });

            if (prs.length > 0) {
              core.info(`PR already exists: #${prs[0].number}`);
              return;
            }

            const title = `feat: ${head.replace(/^feat\//, '')}`;
            const body = [
              'Automatisch erstellter PR aus Feature-Branch.',
              '',
              `- Source: \`${head}\``,
              `- Target: \`${base}\``
            ].join('\n');

            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              head,
              base,
              title,
              body,
              maintainer_can_modify: true
            });

            core.info(`Created PR #${pr.number}`);
