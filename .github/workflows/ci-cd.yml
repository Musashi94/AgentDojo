name: CI/CD Pipeline

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  unit_tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
      - name: Run unit tests
        run: pytest -q tests/test_policy_engine.py tests/test_state_machine_and_schema.py

  integration_tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit_tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
      - name: Runtime kernel integration tests
        run: pytest -q tests/test_runtime_kernel.py

  security_regression:
    name: Security Regression
    runs-on: ubuntu-latest
    needs: integration_tests
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
      - name: Policy hardening regression
        run: pytest -q tests/test_policy_engine.py::test_prompt_injection_triggers_quarantine tests/test_policy_engine.py::test_hard_caps_enforced_and_quarantine_flow
      - name: Secret scan with gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release_readiness:
    name: Release Readiness
    runs-on: ubuntu-latest
    needs: [unit_tests, integration_tests, security_regression]
    permissions:
      contents: write
    outputs:
      decision: ${{ steps.decision.outputs.decision }}
      score: ${{ steps.decision.outputs.score }}
    steps:
      - uses: actions/checkout@v4
      - name: Build release readiness report
        id: decision
        shell: bash
        run: |
          set -euo pipefail
          DATE_UTC=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          score=100
          risks=()

          test -f src/runtime_kernel.py || { score=$((score-30)); risks+=("runtime_kernel missing"); }
          test -f src/state_machine.py || { score=$((score-15)); risks+=("state_machine missing"); }
          test -f src/schemas/run_record.v1.json || { score=$((score-10)); risks+=("run schema missing"); }
          test -f src/schemas/score_record.v1.json || { score=$((score-10)); risks+=("score schema missing"); }
          test -f reports || true

          decision="GO"
          if [ "$score" -lt 85 ]; then
            decision="NO-GO"
          fi

          mkdir -p reports
          {
            echo "# Go/No-Go Release Readiness Report"
            echo
            echo "- Timestamp (UTC): ${DATE_UTC}"
            echo "- Target: v0.2"
            echo "- Score: ${score}/100"
            echo "- Decision: ${decision}"
            echo
            echo "## Validation Gates"
            echo "- Unit tests: PASS"
            echo "- Integration tests: PASS"
            echo "- Security regression: PASS"
            echo
            echo "## Risks"
            if [ ${#risks[@]} -eq 0 ]; then
              echo "- No blocking risks detected in automated readiness checks."
            else
              for r in "${risks[@]}"; do
                echo "- ${r}"
              done
            fi
          } > reports/go-no-go-report.md

          echo "decision=${decision}" >> "$GITHUB_OUTPUT"
          echo "score=${score}" >> "$GITHUB_OUTPUT"

      - name: Upload Go/No-Go report artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-no-go-report
          path: reports/go-no-go-report.md

  deploy:
    name: Deploy (main only)
    runs-on: ubuntu-latest
    needs: release_readiness
    if: github.ref == 'refs/heads/main' && needs.release_readiness.outputs.decision == 'GO'
    steps:
      - uses: actions/checkout@v4
      - name: Simulated release publish
        run: |
          echo "Release readiness score: ${{ needs.release_readiness.outputs.score }}"
          echo "Publishing skill package (simulation)."
