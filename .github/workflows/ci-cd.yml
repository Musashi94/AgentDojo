name: CI/CD Pipeline

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  unit_tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate core markdown artifacts
        shell: bash
        run: |
          set -euo pipefail
          files=(README.md SKILL.md docs/architecture.md docs/threat-model.md docs/scoring-rubric.md)
          for f in "${files[@]}"; do
            test -f "$f"
            test -s "$f"
          done

      - name: Ensure mandatory sections in README
        shell: bash
        run: |
          set -euo pipefail
          grep -q "## Feature Set" README.md
          grep -q "## Security Model" README.md
          grep -q "## Source Quality Scoring" README.md

  integration_tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit_tests
    steps:
      - uses: actions/checkout@v4

      - name: Verify configuration and docs consistency
        shell: bash
        run: |
          set -euo pipefail
          test -f config/agentdojo.config.yaml
          grep -q "selected_agents" config/agentdojo.config.yaml
          grep -q "open_web" config/agentdojo.config.yaml
          grep -q "threat" docs/architecture.md
          grep -q "open-web" docs/threat-model.md

      - name: Verify drill definitions
        shell: bash
        run: |
          set -euo pipefail
          for drill in config/drills/*.yaml; do
            test -s "$drill"
            grep -q "objective:" "$drill"
            grep -q "constraints:" "$drill"
          done

  security_regression:
    name: Security Regression
    runs-on: ubuntu-latest
    needs: integration_tests
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Secret scan with gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dependency and code scan (CodeQL)
        uses: github/codeql-action/init@v3
        with:
          languages: actions

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v3

      - name: Validate threat model contains guardrails
        shell: bash
        run: |
          set -euo pipefail
          grep -qi "policy override" docs/threat-model.md
          grep -qi "destructive" docs/threat-model.md
          grep -qi "quarantine" docs/threat-model.md

  release_readiness:
    name: Release Readiness
    runs-on: ubuntu-latest
    needs:
      - unit_tests
      - integration_tests
      - security_regression
    permissions:
      contents: write
    outputs:
      decision: ${{ steps.decision.outputs.decision }}
      score: ${{ steps.decision.outputs.score }}
    steps:
      - uses: actions/checkout@v4

      - name: Build release readiness report
        id: decision
        shell: bash
        run: |
          set -euo pipefail

          VERSION=$(grep -m1 '^## ' CHANGELOG.md | sed 's/^## //')
          DATE_UTC=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          score=100
          risks=()

          test -f LICENSE || { score=$((score-25)); risks+=("LICENSE missing"); }
          grep -q "## Roadmap" README.md || { score=$((score-10)); risks+=("README roadmap section missing"); }
          grep -q "## Security Model" README.md || { score=$((score-15)); risks+=("README security model section missing"); }
          grep -q "publish" docs/publishing.md || { score=$((score-10)); risks+=("publishing docs incomplete"); }

          decision="GO"
          if [ "$score" -lt 85 ]; then
            decision="NO-GO"
          fi

          mkdir -p reports
          {
            echo "# Go/No-Go Release Readiness Report"
            echo
            echo "- Timestamp (UTC): ${DATE_UTC}"
            echo "- Candidate: ${VERSION}"
            echo "- Score: ${score}/100"
            echo "- Decision: ${decision}"
            echo
            echo "## Validation Gates"
            echo "- Unit tests: PASS"
            echo "- Integration tests: PASS"
            echo "- Security regression: PASS"
            echo
            echo "## Risks"
            if [ ${#risks[@]} -eq 0 ]; then
              echo "- No blocking risks detected in automated readiness checks."
            else
              for r in "${risks[@]}"; do
                echo "- ${r}"
              done
            fi
            echo
            echo "## Recommendation"
            if [ "$decision" = "GO" ]; then
              echo "Proceed with release and keep post-release monitoring active."
            else
              echo "Block release and remediate identified risks before retry."
            fi
          } > reports/go-no-go-report.md

          echo "decision=${decision}" >> "$GITHUB_OUTPUT"
          echo "score=${score}" >> "$GITHUB_OUTPUT"

      - name: Upload Go/No-Go report artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-no-go-report
          path: reports/go-no-go-report.md

  deploy:
    name: Deploy (main only)
    runs-on: ubuntu-latest
    needs: release_readiness
    if: github.ref == 'refs/heads/main' && needs.release_readiness.outputs.decision == 'GO'
    steps:
      - uses: actions/checkout@v4
      - name: Simulated release publish
        shell: bash
        run: |
          set -euo pipefail
          echo "Release readiness score: ${{ needs.release_readiness.outputs.score }}"
          echo "Publishing skill package (simulation)."
